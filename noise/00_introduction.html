<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Noise - ASMTP</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../keynesis/00_introduction.html"><strong aria-hidden="true">2.</strong> Keynesis</a></li><li class="chapter-item expanded "><a href="../noise/00_introduction.html" class="active"><strong aria-hidden="true">3.</strong> Noise</a></li><li class="chapter-item expanded "><a href="../poldercast/00_introduction.html"><strong aria-hidden="true">4.</strong> Poldercast</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">ASMTP</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="noise"><a class="header" href="#noise">Noise</a></h1>
<p>The <a href="https://noiseprotocol.org">Noise Protocol</a> is a framework that we use for our cryptographic
protocols. It defines how to establish encrypted sessions between
senders and recipients.</p>
<blockquote>
<p>Noise protocols support mutual and optional authentication, identity hiding,
forward secrecy, zero round-trip encryption, and other advanced features.</p>
</blockquote>
<ul>
<li><em>mutual authentication</em>: it means all the participants are proving to
their identity to each others;</li>
<li><em>identity hiding</em>: means that no outside observer can find out the
identity of the participants;</li>
<li><em>forward secrecy</em>: it means that even if the long term keys of the participants
are compromised the session keys are protected as well as protecting the past
keys if the recent keys are compromised. In other words: we are protecting
the past communications.</li>
<li><em>zero round-trip encryption</em>: it is possible to send encrypted application
data to a recipient without prior exchanged messages.</li>
</ul>
<p>How the encrypted sessions are established is called Handshake Patterns. These
are the first sequence of messages the participants are to exchanged in order
to establish the encrypted session.</p>
<p>We are leveraging different of these handshake pattens in our protocols. These
patterns are described below.</p>
<h2 id="pattern-x"><a class="header" href="#pattern-x">Pattern: <code>X</code></a></h2>
<ul>
<li>✅ Mutual authentication</li>
<li>✅ Zero round trip encryption</li>
<li>✅ Identity hiding</li>
<li>❌ Forward secrecy</li>
</ul>
<p>This pattern allows for 0 round trip encryption. Yet it allows to authenticate
both the sender to the receiver (the sender's public key is transmitted in the
message -- encrypted). Only the recipient can retrieve the identity of the sender.</p>
<p>This type of message is used by <strong>ASMTP</strong> to encrypt the messages users will
send to each other. The <code>Public Key</code> used here are the <code>Shared Key</code> in Alice's
and Bob's respective passports.</p>
<h3 id="encrypting-the-message"><a class="header" href="#encrypting-the-message">encrypting the message</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Alice
    participant Session
    participant Bob
    autonumber

    Bob--)Alice: Bob's Public Key

    Note over Alice,Session: Alice starts sending a message to Bob

    Alice-&gt;&gt;+Alice: generate ephemeral key
    Alice--&gt;&gt;Session: serialise ephemeral public key
    Alice-&gt;&gt;-Session: DH(ephemeral key, Bob's public key)
    
    Alice--&gt;&gt;Session: serialise Alice's Public Key
    Alice-&gt;&gt;Session: DH(Alice's Key, Bob's public key)

    Alice--&gt;&gt;Session: Encrypt payload
</pre>
<ol>
<li>Alice needs to know Bob's public key in advance;</li>
<li>Alice generates an ephemeral key. Its lifetime is limited to the configuration of the session and needs the key will need to be securely destroyed once no longer needed;</li>
<li>Alice sets the ephemeral public key in the session. It is serialized in the message payload and is used to update the encryption state of the session;</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between the ephemeral private key and Bob's public key. Alice can now destroy the ephemeral secret key.</li>
<li>Alice sets her public key in the session. It is serialized in the mesasge payload and is used to update the encryption state of the session;</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between her private key and Bob's public key.</li>
<li>Alice sets the payload to encrypt.</li>
</ol>
<h3 id="decrypting-the-message"><a class="header" href="#decrypting-the-message">decrypting the message</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Session
    participant Bob
    autonumber

    Note over Session,Bob: Bob starts reading a message

    Session--&gt;&gt;Bob: deserialize ephemeral public key
    
    Bob-&gt;&gt;Session: DH(Bob's Key, Ephemeral's public key)

    Session--&gt;&gt;Bob: deserialize sender's public key

    Note over Bob,Session: Bob now knows the message is from Alice (sender's public key)

    Bob-&gt;&gt;Session: DH(Bob's Key, Sender's public key)
    Session--&gt;&gt;Bob: Decrypt payload
</pre>
<ol>
<li>Bob deserializes the ephemeral public key from the payload;</li>
<li>Bob sets the result of the key exchange (<em>DH</em>) between his private key and the deserialized ephemeral public key;</li>
<li>Bob deserializes the sender's public key.</li>
<li>Bob sets the result of the key exchange (<em>DH</em>) between his private key and the deserialized sender's public key;</li>
<li>Bob decrypts the payload</li>
</ol>
<p>More info on <a href="https://noiseexplorer.com/patterns/X/"><code>Noise's explorer</code></a></p>
<h2 id="pattern-npsk0"><a class="header" href="#pattern-npsk0">Pattern: <code>Npsk0</code></a></h2>
<ul>
<li>✅ Mutual authentication: thanks to the psk</li>
<li>✅ Zero round trip encryption: we only care about the recipient reading the message</li>
<li>✅ Identity hiding: it is not possible to know who are the participants of this exchange</li>
<li>❌ Forward secrecy: if the <code>psk</code> or the recipient keys are compromised the message is compromised</li>
</ul>
<p>This pattern is used to encrypt the shared secret key in the passport's blocks.
Using this pattern allows us to have a fairly small encrypted data
in the passport that requires only the extra ephemeral public key
to be stored along with the encrypted data.</p>
<h3 id="encrypting-the-message-1"><a class="header" href="#encrypting-the-message-1">encrypting the message</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Alice
    participant Session
    participant Bob
    autonumber

    Bob--)Alice: Bob's Public Key

    Note over Alice,Session: Alice starts sending a message to Bob

    rect rgba(0, 0, 255, .1)
      Alice-&gt;&gt;Session: pre-shared secret (password)
    end

    Alice-&gt;&gt;+Alice: generate ephemeral key
    Alice--&gt;&gt;Session: serialise ephemeral public key
    
    Alice-&gt;&gt;-Session: DH(Ephemeral Key, Bob's public key)

    Alice--&gt;&gt;Session: Encrypt payload
</pre>
<ol>
<li>Alice needs to know Bob's public key in advance;</li>
<li>Alice sets a pre-shared secret, usually it can be a password for example. Bob will need to be aware of that secret too in order to decrypt the message;</li>
<li>Alice generates an ephemeral key. Its lifetime is limited to the configuration of the session and needs the key will need to be securely destroyed once no longer needed;</li>
<li>Alice sets the ephemeral public key in the session. It is serialized in the message payload and is used to update the encryption state of the session;</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between the ephemeral private key and Bob's public key. Alice can now destroy the ephemeral secret key.</li>
<li>Alice sets the payload to encrypt.</li>
</ol>
<h3 id="decrypting-the-message-1"><a class="header" href="#decrypting-the-message-1">decrypting the message</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Session
    participant Bob
    autonumber

    Note over Session,Bob: Bob starts reading a message from Alice

    rect rgba(0, 0, 255, .1)
      Bob-&gt;&gt;Session: pre-shared secret (password)
    end

    Session--&gt;&gt;Bob: deserialise ephemeral public key
    
    Bob-&gt;&gt;Session: DH(Bob's Key, Ephemeral's public key)

    Session--&gt;&gt;Bob: Decrypt payload
</pre>
<ol>
<li>Bob sets the pre-shared secret, it needs to be the same as the one Alice used;</li>
<li>Bob deserializes the ephemeral public key from the payload;</li>
<li>Bob sets the result of the key exchange (<em>DH</em>) between his private key and the deserialized ephemeral public key;</li>
<li>Bob decrypts the payload</li>
</ol>
<p>More info on <a href="https://noiseexplorer.com/patterns/Npsk0/"><code>Noise's explorer</code></a></p>
<h2 id="pattern-ik"><a class="header" href="#pattern-ik">Pattern: <code>IK</code></a></h2>
<ul>
<li>✅ Mutual authentication</li>
<li>❌ Zero round trip encryption</li>
<li>✅ Identity hiding</li>
<li>✅ Forward secrecy</li>
</ul>
<p>In only one round trip we can establish the most secure form of encrypted
session available to us. The only prerequisite to establish this kind of
session is to know in advance the public key of the remote peer.</p>
<p>It starts exactly like the <code>X</code> pattern described previously. However we are
assuming the session to be finally started after another message is received
from the recipient.</p>
<p>This pattern is used to establish secure and long connections between nodes
on the network. The public keys used here are the same one serialised in the
<a href="../poldercast/00_introduction.html#gossips">poldercast's gossips</a>. This guarantees we are talking to the appropriate
nodes for the right reasons (see <a href="../poldercast/00_introduction.html">poldercast</a> for more details).</p>
<h3 id="encrypting-the-message-2"><a class="header" href="#encrypting-the-message-2">encrypting the message</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Alice
    participant Session
    participant Bob
    autonumber

    Bob--)Alice: Bob's Public Key

    Note over Alice,Session: Alice starts sending a message to Bob

    Alice-&gt;&gt;+Alice: generate Alice's ephemeral key
    Alice--&gt;&gt;Session: serialise Alice's ephemeral public key
    Alice-&gt;&gt;Session: DH(Alice's ephemeral key, Bob's public key)
    
    Alice--&gt;&gt;Session: serialise Alice's Public Key
    Alice-&gt;&gt;Session: DH(Alice's Key, Bob's public key)

    Note over Session,Bob: Bob processes the message and replies

    Session--&gt;&gt;Alice: deserialize Bob's ephemeral public key
    Alice-&gt;&gt;-Session: DH(Alice's ephemeral key, Bob's ephemeral public key)
    Alice-&gt;&gt;Session: DH(Alice's key, Bob's ephemeral public key)
    

    par sending messages
      Alice--)Session: Encrypt payload
    and receiving messages
      Session--)Alice: Decrypt payload
    end
</pre>
<ol>
<li>Alice needs to know Bob's public key in advance;</li>
<li>Alice generates an ephemeral key. Its lifetime is limited to the configuration of the session and needs the key will need to be securely destroyed once no longer needed;</li>
<li>Alice sets Alice's ephemeral public key in the session. It is serialized in the message payload and is used to update the encryption state of the session;</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between Alice's ephemeral private key and Bob's public key.</li>
<li>Alice sets her public key in the session. It is serialized in the message payload and is used to update the encryption state of the session;</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between her private key and Bob's public key.</li>
<li>Alice deserializes Bob's ephemeral public key;</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between Alice's ephemeral private key and Bob's ephemeral public key. Alice's ephemeral key can now be securely destroyed.</li>
<li>Alice sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between Alice's private key and Bob's ephemeral public key.</li>
<li>Alice can use the session to send messages to Bob</li>
<li>Alice can use the session to receive messages from Bob</li>
</ol>
<h3 id="decrypting-the-message-2"><a class="header" href="#decrypting-the-message-2">decrypting the message</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Session
    participant Bob
    autonumber

    Note over Session,Bob: Bob starts reading a message

    Session--&gt;&gt;Bob: deserialize sender's ephemeral public key
    
    Bob-&gt;&gt;Session: DH(Bob's Key, Sender's ephemeral public key)

    Session--&gt;&gt;Bob: deserialize sender's public key

    Note over Bob,Session: Bob now knows the message is from Alice (sender's public key)

    Bob-&gt;&gt;Session: DH(Bob's Key, Alice's public key)

    Bob-&gt;&gt;+Bob: generate Bob's ephemeral key
    Bob--&gt;&gt;Session: serialise Bob's ephemeral public key
    Bob-&gt;&gt;Session: DH(Bob's ephemeral key, Alice's ephemeral public key)
    Bob-&gt;&gt;-Session: DH(Bob's ephemeral key, Alice's public key)

    par sending messages
      Session--)Bob: Decrypt payload
    and receiving messages
      Bob--)Session: Encrypt payload
    end
</pre>
<ol>
<li>Bob deserializes the sender's ephemeral public key from the payload;</li>
<li>Bob sets the result of the key exchange (<em>DH</em>) between his private key and the sender's ephemeral public key;</li>
<li>Bob deserializes the sender's public key, we now know it is Alice.</li>
<li>Bob sets the result of the key exchange (<em>DH</em>) between his private key and Alice's public key;</li>
<li>Bob generates an ephemeral key. Its lifetime is limited to the configuration of the session and needs the key will need to be securely destroyed once no longer needed;</li>
<li>Bob sets Bob's ephemeral public key in the session. It is serialized in the message payload and is used to update the encryption state of the session;</li>
<li>Bob sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between Bob's ephemeral private key and Alice's ephemeral public key.</li>
<li>Bob sets the result of the key exchange (Diffie-Hellman: <em>DH</em>) between Bob's ephemeral private key and Alice's public key.</li>
<li>Bob can use the session to receive messages from Alice</li>
<li>Bob can use the session to send messages to Alice</li>
</ol>
<p>More info on <a href="https://noiseexplorer.com/patterns/IK/"><code>Noise's explorer</code></a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../keynesis/00_introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../poldercast/00_introduction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../keynesis/00_introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../poldercast/00_introduction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../mermaid-init.js"></script>
        

        

    </body>
</html>
